<body>
    <table id="adminDatagrid"></table>
    <div id="newAdminDialog" hidden></div>
    <div id="editAdminDialog" hidden></div>
    <script>
        $('#adminDatagrid').datagrid({
            columns: [
                [{
                    field: 'id',
                    hidden: true
                }, {
                    field: 'username',
                    title: '用户名',
                    align: 'center',
                    width: 100
                }, {
                    field: 'realname',
                    title: '姓名',
                    align: 'center',
                    width: 100
                }, {
                    field: 'phone',
                    title: '手机号码',
                    align: 'center',
                    width: 100
                }, {
                    field: 'address',
                    title: '地址',
                    align: 'center',
                    width: 100
                }, {
                    field: 'isAdmin',
                    title: '是否为管理员',
                    align: 'center',
                    width: 100,
                    formatter: dict.yesOrNo
                }]
            ]
        });
        easyuiConfig.loadData("adminDatagrid", "/user");
        var userMan = {
            addAdmin: () => {
                easyuiConfig.newDialog("newAdminDialog", '新建管理员', 350, 300, "/system/newAdmin.html", () => {
                    if ($("#newAdminForm").form('validate')) {
                        $.post("/user/add", $("#newAdminForm").serialize(), data => {
                            if (data != DICT_CONSTANTS.ERROR) {
                                $.messager.alert('系统提示', '管理员' + data + '保存成功！');
                                $("#newAdminDialog").dialog('close');
                                easyuiConfig.loadData("adminDatagrid", "/user");
                            } else {
                                $.messager.alert('系统提示', '管理员保存失败！');
                                $("#newAdminDialog").dialog('close');
                            }
                        });
                    }
                });
            },
            editAdmin: () => {
                let userJson = $("#adminDatagrid").datagrid('getSelected');
                if (userJson != null) {
                    easyuiConfig.newDialog("editAdminDialog", '修改管理员', 350, 250, "/system/editAdmin.html", () => {
                        if ($("#editAdminForm").form('validate')) {
                            $.post("/user/edit", $("#editAdminForm").serialize(), data => {
                                if (data != DICT_CONSTANTS.ERROR) {
                                    $.messager.alert('系统提示', '管理员' + data + '保存成功！');
                                    $("#editAdminDialog").dialog('close');
                                    easyuiConfig.loadData("adminDatagrid", "/user");
                                } else {
                                    $.messager.alert('系统提示', '管理员保存失败！');
                                    $("#editAdminDialog").dialog('close');
                                }
                            });
                        }
                    });
                } else {
                    $.messager.alert('系统提示', '请选择要编辑的行！');
                }
            },
            deleteAdmin: () => {
                let userJson = $("#adminDatagrid").datagrid('getSelected');
                if (userJson != null) {
                    $.messager.confirm('系统提示', '你确定要删除管理员' + userJson.realname + '吗？', flag => {
                        if (flag) {
                            $.post("/user/" + userJson.id, data => {
                                if (data != DICT_CONSTANTS.ERROR) {
                                    $.messager.alert('系统提示', '删除成功！');
                                    easyuiConfig.loadData("adminDatagrid", "/user");
                                } else {
                                    $.messager.alert('系统提示', '删除失败！');
                                }
                            });
                        }
                    });
                } else {
                    $.messager.alert('系统提示', '请选择要删除的行！');
                }
            },
            userRole: () => {
                let userJson = $("#adminDatagrid").datagrid('getSelected');
                if (userJson != null) {
                    easyuiConfig.newDialog("newAdminDialog", '分配角色', 550, 500, "/system/userRole.html", () => {
                        let roleIds = [];
                        let roles = $("#userRoleDatagrid").datagrid('getChecked');
                        if (roles.length < 1) {
                            $.messager.alert('系统提示', '至少要选中一个角色');
                            return;
                        }
                        roles.map(role => roleIds.push(role.id));
                        $.post("/role/allot", {
                            userId: userJson.id,
                            roleIds: JSON.stringify(roleIds)
                        }, data => {
                            if (data != DICT_CONSTANTS.ERROR) {
                                $.messager.alert('系统提示', '分配角色成功！');
                                $("#newAdminDialog").dialog('close');
                            } else {
                                $.messager.alert('系统提示', '分配失败！');
                                $("#newAdminDialog").dialog('close');
                            }
                        });
                    });
                } else {
                    $.messager.alert('系统提示', '请选择要分配的用户！');
                }
            }
        }
        easyuiConfig.setToolbar("adminDatagrid", {
            add: userMan.addAdmin,
            edit: userMan.editAdmin,
            delete: userMan.deleteAdmin
        }, [{
            iconCls: 'icon-large-chart',
            text: '分配角色',
            handler: userMan.userRole
        }]);
    </script>
</body>