<!DOCTYPE html>
<html lang="en">

<body>
    <script>
        const roleMan = {
            addRole: () => {
                $('#roleDatagrid').edatagrid('addRow');
            },
            editRole: () => {
                let row = $('#roleDatagrid').edatagrid('getSelected');
                if (row == null) {
                    $.messager.alert('系统提示', '请选择要编辑的行！');
                    return;
                }
                let index = $('#roleDatagrid').edatagrid('getRowIndex', row);
                $('#roleDatagrid').edatagrid('editRow', index);
            },
            deleteRole: () => {
                let roleJson = $("#roleDatagrid").datagrid('getSelected');
                if (roleJson != null) {
                    $.messager.confirm('系统提示', '你确定要删除角色' + roleJson.name + '吗？', flag => {
                        if (flag) {
                            $.post("/user/deleteRole/" + roleJson.id, data => {
                                if (data != '') {
                                    $.messager.alert('系统提示', data);
                                    $("#roleDatagrid").datagrid('reload');
                                } else {
                                    $.messager.alert('系统提示', '删除失败！');
                                }
                            });
                        }
                    });
                } else {
                    $.messager.alert('系统提示', '请选择要删除的行！');
                }
            },
            roleMenu: () => {
                let roleJson = $("#roleDatagrid").datagrid('getSelected');
                if (roleJson != null) {
                    easyuiConfig.newDialog("roleDialog", '分配菜单', 550, 500, "/system/roleMenu.html", () => {
                        let menuIds = [];
                        let menus = $("#roleMenuTreegrid").treegrid('getCheckedNodes');
                        if (menus.length < 2) {
                            $.messager.alert('系统提示', '要选中一个以上菜单');
                            return;
                        }
                        menus.map(menu => menuIds.push(menu.id));
                        $.post("/user/roleMenu", {
                            roleId: roleJson.id,
                            menuIds: menuIds
                        }, data => {
                            if (data != '') {
                                $.messager.alert('系统提示', data);
                                $("#roleDialog").dialog('close');
                            } else {
                                $.messager.alert('系统提示', '分配失败！');
                                $("#roleDialog").dialog('close');
                            }
                        });
                    });
                } else {
                    $.messager.alert('系统提示', '请选择要分配的角色！');
                }
            }
        }
        $(() => {
            $('#roleDatagrid').edatagrid({
                url: '/user/showRoleList',
                saveUrl: '/user/addRole',
                updateUrl: '/user/editRole',
                onAfterEdit: (index, row) => {
                    $.messager.alert('系统提示', '保存成功！', () => $('#roleDatagrid').edatagrid('reload'));
                }
            });
            easyuiConfig.setToolbar("roleDatagrid", {
                add: roleMan.addRole,
                edit: roleMan.editRole,
                delete: roleMan.deleteRole
            }, [{
                iconCls: 'icon-cancel',
                text: '取消',
                handler: () => {
                    $('#roleDatagrid').edatagrid('cancelRow');
                }
            }, {
                iconCls: 'icon-save',
                text: '保存',
                handler: () => {
                    $('#roleDatagrid').edatagrid('saveRow');
                }
            }, {
                iconCls: 'icon-large-chart',
                text: '分配菜单',
                handler: roleMan.roleMenu
            }]);
        });
    </script>
    <div id="roleDialog" hidden></div>
    <table id="roleDatagrid">
        <thead>
            <tr>
                <th field="id" hidden="true"></th>
                <th field="code" width="100" align="center" editor="{type:'validatebox',options:{required:true}}">编号</th>
                <th field="name" width="100" align="center" editor="{type:'validatebox',options:{required:true}}">角色名称</th>
            </tr>
        </thead>
    </table>
</body>

</html>